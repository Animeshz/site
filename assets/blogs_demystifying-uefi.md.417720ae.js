import{_ as C,H as a,o as c,c as D,C as o,a as n,t as d,J as e,E as l,V as i,D as F,G as m}from"./chunks/framework.d1c50dd7.js";const b="/site/assets/processor-chip.1de84aef.jpg",S=JSON.parse(`{"title":"Demystifying UEFI","description":"Easily understand everything you're missing about UEFI","frontmatter":{"title":"Demystifying UEFI","description":"Easily understand everything you're missing about UEFI","created":"2023-05-10 2:03 PM","image":"/blogs/demystifying-uefi/processor-chip.jpg","tags":["demystifying","uefi","low-level"]},"headers":[],"relativePath":"blogs/demystifying-uefi.md","filePath":"blogs/demystifying-uefi.md","lastUpdated":1695366908000}`),A={name:"blogs/demystifying-uefi.md"},h={id:"frontmatter-title",tabindex:"-1"},f=o("a",{class:"header-anchor",href:"#frontmatter-title","aria-label":'Permalink to "{{ $frontmatter.title }}"'},"​",-1),g=i('<p><img src="'+b+`" alt="Cover Image"></p><p><strong>Today</strong> I did something really cool, made UKI (in the article) after few weeks of attempt.</p><p>Has this ever happened to you? After a long time, errors seem to go away and <em>everything starts working again</em>. Its such a nice feeling.</p><p>As an occassional low-level programming enjoyer, it feels really nice to work with something that you use everyday but are unaware of how it really works under the hood.</p><p>Let me show it by example, <em>sqaure root</em>, a simple thing right? How does it look in code, more simply how do you calculate it except just hit n trial? Computer does it in a deterministic way. Although I needed atleast 25-30 jump-to-definitions in Java&#39;s source code to find out how it actually worked. And simplified, its as simple as:</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">double</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sqrt</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">double</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">double</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">  // TBH anything, really, except 0 ofc.</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    a </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0.5</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">a </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> n</span><span style="color:#89DDFF;">/</span><span style="color:#F07178;">a</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>What the ƒυ¢к? Weren&#39;t we trying to calculate n to the power of 1/2? Really we do, but we can write the equation of power 1/2 in linear form (power 1). Now for those interested in how does this work, refer <a href="https://en.wikipedia.org/wiki/Newton%27s_method#Description" target="_blank" rel="noreferrer">Newton&#39;s Method</a>, its really simple.</p><p>The point is, exploring 25-30 definition jumps was worth it in the end!</p><p><em>UEFI</em> is quite similar too, its something that we use every single day, yet we&#39;re mostly unaware of how it works, and hence the curious boy will do everything to unravel the mystery.</p><h2 id="fundamentals-about-computers" tabindex="-1">Fundamentals about computers <a class="header-anchor" href="#fundamentals-about-computers" aria-label="Permalink to &quot;Fundamentals about computers&quot;">​</a></h2><p>I recently saw a video <a href="https://youtu.be/ZSSNFkEMv24" target="_blank" rel="noreferrer">What is voltage? (joke video)</a> posted on the April fools day, questioning why did it take you 5 years to fully understand the voltage. Its really funny one, I&#39;d encourage you to check it out. Its really feels daunting when society makes it difficult, by telling partial-statements and incrementally correct it out with time while not telling the most obvious truth.</p><p>It may seem a bit <em>boring</em>, maybe. But the way we want to start demystifying UEFI is by looking at the most obvious truth about computers.</p><p>That computers are made up of little switches (also known as transistors). When we press the power button, we let some electricity flow into the BIOS/CMOS chip for a short duration of time. These chips generally contains an EPROM (Erasable Programmable Read-Only Memory) which is flashed with something called as a firmware-descriptor (fd) through some equipments externally.</p><p>With a small flow of electricity, the firmware-descriptor present (which also contains the UEFI screen you see by pressing f2/f10 at the boot time), in the chip starts the booting sequence, by opening some gate and activating DRAM, then CPU then rest of the components.</p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Efi-simple.svg/1200px-Efi-simple.svg.png" width="40%" style="margin:auto;"><p>Once the RAM and the CPU is functional for the first time, it scans all the vFAT partitions in the connected drives and start looking for <code>/EFI/*/*.efi</code> files. Once it finds one, it tries to launch and give full hardware control to it.</p><h2 id="the-efi-file" tabindex="-1">The *.efi file <a class="header-anchor" href="#the-efi-file" aria-label="Permalink to &quot;The \\*.efi file&quot;">​</a></h2><p>This one&#39;s really <em>interesting</em>. When your computer has just started off, it knows nothing about what to do, and this is the first file that tells it what to do.</p><p>In contrast, the *.efi file is just a simple binary, except that a few restrictions have been imposed by the <a href="https://uefi.org/sites/default/files/resources/UEFI%20Spec%202.8B%20May%202020.pdf" target="_blank" rel="noreferrer">UEFI Specifications</a>, namely the binary must use Microsoft ABI, be position independent, and the binary format should be PE32+ (self-contained) not the regular ELF (OS-dependent) that we use.</p><p>If we understand even a bit of it, we know that we need to build a binary targeting Microsoft Windows, and it doesn&#39;t use any of standard libraries (since there&#39;s no OS).</p><p>So let&#39;s just make a Hello World efi binary, because,</p>`,21),E=o("br",null,null,-1),w=i(`<h3 id="efi-programming-model" tabindex="-1">EFI Programming Model <a class="header-anchor" href="#efi-programming-model" aria-label="Permalink to &quot;EFI Programming Model&quot;">​</a></h3><p>Before we begin, we first have to know a few things,</p><ul><li>We can&#39;t use any of the standard headers that depend on the OS, not even <code>iostream</code> or <code>stdio.h</code>.</li><li>UEFI fd exposes a few functionalities by giving our efi entrypoint two parameters, that are pointer of <code>EFI_HANDLE</code> and <code>EFI_SYSTEM_TABLE</code>. The one that is useful to us is the latter one, it&#39;ll let us write to the console.</li><li>LLVM/Clang compiler toolchain (clang+lld) provides built-in support for cross-compilation (otherwise we&#39;d have to <a href="https://github.com/Animeshz/mainstream-cross-compilers" target="_blank" rel="noreferrer">compile gcc targeting windows</a> and even after that we&#39;d have to tell it to use Microsoft ABI at link-time).</li></ul><h3 id="hello-world-in-efi" tabindex="-1">Hello World in EFI <a class="header-anchor" href="#hello-world-in-efi" aria-label="Permalink to &quot;Hello World in EFI&quot;">​</a></h3><p>First let&#39;s install the dependencies we&#39;d require to build our first EFI code:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xbps-install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clang</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Here&#39;s a basic <code>Makefile</code> setup for compiling our first EFI code.</p><div class="language-make line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">make</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">CC </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> clang</span></span>
<span class="line"><span style="color:#A6ACCD;">LD </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> lld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">CFLAGS </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> -ffreestanding -MMD -mno-red-zone -std=c11 -target x86_64-unknown-windows</span></span>
<span class="line"><span style="color:#A6ACCD;">LDFLAGS </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> -flavor link -subsystem:efi_application -entry:efi_main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">default</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> all clean</span></span>
<span class="line"><span style="color:#82AAFF;">all</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> main.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">%.o</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> %.c</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">$(</span><span style="color:#A6ACCD;">CC</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#A6ACCD;">CFLAGS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -c $&lt; -o $@</span></span>
<span class="line"><span style="color:#82AAFF;">%.efi</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> %.o</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">$(</span><span style="color:#A6ACCD;">LD</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#A6ACCD;">LDFLAGS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> $&lt; -out:$@</span></span>
<span class="line"><span style="color:#82AAFF;">clean</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">	rm -fv *.o *.d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">.PHONY</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> clean all default</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Let&#39;s open up <code>main.c</code> now and define out entry point,</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">stdint.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">uint64_t</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">efi_main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">handle</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">system_table</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>and run <code>make</code>, it should produce a <code>main.efi</code> file, and we can run <code>file main.efi</code> to ensure its metadata are as expected.</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span></span>
<span class="line"><span style="color:#FFCB6B;">clang</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-ffreestanding</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-MMD</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-mno-red-zone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-std=c11</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-target</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">x86_64-unknown-windows</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.o</span></span>
<span class="line"><span style="color:#FFCB6B;">lld</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-flavor</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">link</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-subsystem:efi_application</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-entry:efi_main</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-out:main.efi</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-fv</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.o</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.d</span></span>
<span class="line"><span style="color:#FFCB6B;">removed</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">main.o</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">removed</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">main.d</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.efi</span></span>
<span class="line"><span style="color:#FFCB6B;">main.efi:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PE32+</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">executable</span><span style="color:#A6ACCD;"> (EFI </span><span style="color:#C3E88D;">application</span><span style="color:#A6ACCD;">) x86-64, </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> MS Windows</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="making-a-test-environment" tabindex="-1">Making a test environment <a class="header-anchor" href="#making-a-test-environment" aria-label="Permalink to &quot;Making a test environment&quot;">​</a></h3><p>Till now, everything seems great, although I don&#39;t think its a good idea to just throw the efi file to the <code>/boot/efi</code> and start booting your laptop/pc from it.</p><p>A better approach would be to spin up a small qemu vm and run the efi image/binary from there.</p><p>First let&#39;s install the dependencies:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xbps-install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">qemu</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Now we spin up a new qemu vm with current directory serving as a root filesystem to the vm:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">qemu-system-x86_64</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-drive</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">if=pflash,format=raw,readonly,file=/usr/share/qemu/edk2-x86_64-code.fd</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-drive</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">format=raw,file=fat:rw:</span><span style="color:#A6ACCD;">$PWD \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-net</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">none</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-nographic</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The important options are the two <code>-drive</code> options, first tells the VM to use the edk2 firmware-descriptor as UEFI (similar to one flashed on to your EPROM in the BIOS chip), the second mounts current directory (<code>$PWD</code>) as a vFAT filesystem in the VM.</p><p>Rest of options are just personal preference, <code>-net none</code> tells to not provide any network access to the vm, <code>-nographic</code> tells qemu can occupy our current terminal instead of a new graphical window (its convenient as I&#39;m majorly a keyboard-centric guy).</p><p>This should drop you to a EFI shell, to load your efi file, run the following:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Shell&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fs0:</span></span>
<span class="line"><span style="color:#FFCB6B;">fs0:\\&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.efi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>It outputs nothing, and that&#39;s good thing because there were no errors, hence everything worked perfectly!</p><h3 id="hello-world-in-efi-continue" tabindex="-1">Hello World in EFI (continue) <a class="header-anchor" href="#hello-world-in-efi-continue" aria-label="Permalink to &quot;Hello World in EFI (continue)&quot;">​</a></h3><p>So far, we ran the efi binary, but we didn&#39;t print &quot;Hello World&quot; as we promised. So let&#39;s just do exactly that.</p><p>To do that, we can&#39;t use <code>iostream</code> or <code>stdio.h</code>, since there&#39;s no OS outside the UEFI environment there&#39;s no implementation of those headers, but we know that UEFI gave us two paramters in our entry point. Maybe that could help us?</p><p>And the answer is yes, the UEFI has started the screen and knows how to write something to the console, the pointer to <code>EFI_SYSTEM_TABLE</code> contains routines (function pointers) that we can call to perform some actions available.</p><p>So, let&#39;s modify our <code>main.c</code> file:</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">stdint.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">stdbool.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_table_header</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> signature</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> revision</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> header_size</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> crc32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> reserved</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_table_header</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused1</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">bool</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">output_string</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint16_t</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">string</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused2</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint16_t</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused3</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused4</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused5</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">clear_screen</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">self</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused6</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">unused7</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">*</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">bool</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_simple_text_output_protocol</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_system_table</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  efi_table_header header</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint16_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> unused2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused3</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused5</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  efi_simple_text_output_protocol </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">out</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused6</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused7</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused9</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">uint64_t</span><span style="color:#F07178;"> unused10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">unused11</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">efi_system_table</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">uint64_t</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">efi_main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">handle</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">efi_system_table</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">*</span><span style="color:#A6ACCD;font-style:italic;">system_table</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">uint16_t</span><span style="color:#A6ACCD;"> msg[] </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">u&quot;</span><span style="color:#C3E88D;">Hello World!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">uint64_t</span><span style="color:#A6ACCD;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">clear_screen</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">output_string</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>Ok, too much to ingest. But first let&#39;s compile and run,</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">qemu-system-x86_64</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-drive</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">if=pflash,format=raw,readonly,file=/usr/share/qemu/edk2-x86_64-code.fd</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-drive</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">format=raw,file=fat:rw:</span><span style="color:#A6ACCD;">$PWD \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-net</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">none</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">-nographic</span></span>
<span class="line"><span style="color:#FFCB6B;">Shell&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fs0:</span></span>
<span class="line"><span style="color:#FFCB6B;">fs0:\\&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">Hello</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">World!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Voila! We finally been able to write a Hello World on the UEFI console!</p><p>The code basically defines (because I wanted the code to be any dependency-free), and use the simple text io interface from the <code>EFI_SYSTEM_TABLE</code> (that is the second parameter to our entrypoint).</p><p>Where there are two important function pointers, <code>clear_screen</code> and <code>output_string</code>. It seems that accross the UEFI Specification they mostly use UCS-2 encoded strings (16-bit wide), so we define our string as unicode <code>u&quot;Hello World!&quot;</code> and pass it to the <code>output_string</code>.</p><p>That&#39;s it, now you can start whatever you want to do with UEFI, it also provides graphics and filesystem API through the same <code>EFI_SYSTEM_TABLE</code> so you can draw something or load up other binaries, kernels, and more. And that&#39;s what most UEFI implementations do, like for example <strong>grub</strong>, or other <strong>edk2 applications such as Ventoy</strong>.</p><h2 id="unified-kernel-image-uki" tabindex="-1">Unified Kernel Image (UKI) <a class="header-anchor" href="#unified-kernel-image-uki" aria-label="Permalink to &quot;Unified Kernel Image (UKI)&quot;">​</a></h2><p>Another interesting usecase of learning about UEFI is that now you can make a portable linux efi image. That basically package efi-stub, initramfs/initrd, kernel, (optionally) rootfs all in a single *.efi file. Making computer need no more than a single file to boot up a linux.</p><p>They help us in two ways,</p><ul><li>Allow a direct netboot (without a disk).</li><li>Boot up really <em>really</em> fast (ignoring middle-man like grub).</li></ul><p>Let me tell you a story, a few weeks ago, in our college, we had to create a cluster for ML purposes, where we had to boot multiple computers at once and spin up all of them to do the required things. To do this, we obviously had to create a self-configuring or self-configured image, and perform a netboot (that can be done by serving the file from any computer using simple built-in http server: <code>python3 -m http.server</code>) so that we won&#39;t have to plug the USB stick everytime to each and every of the computers out there, and also to not affect the internal disks (that&#39;s why we&#39;re doing netboot), we had to load everything in RAM. What could be better than Unified Kernel Images?</p><p>And for geeks like us as well, who don&#39;t use more than 1 OS, we don&#39;t really need the grub, and thus we can speed up our boot process by utilizing the UKI.</p><p>So, let&#39;s try building one!</p><h3 id="building-a-uki-for-currently-running-desktop-linux" tabindex="-1">Building a UKI for currently running desktop linux <a class="header-anchor" href="#building-a-uki-for-currently-running-desktop-linux" aria-label="Permalink to &quot;Building a UKI for currently running desktop linux&quot;">​</a></h3><p>Fortunately enough, the dracut generally described as &quot;a low-level tool for generating an initramfs/initrd image&quot;, supports building a UKI. So if you&#39;re on any modern linux distribution and already using dracut under the hood, you can easily adapt to UKI without much of a hassle.</p><p>To do this, first we would need a efi-stub,</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xbps-install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gummiboot</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>and then we specify UKI configuration, in a file say <code>my-dracut-uki.conf</code>:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">uefi</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span>
<span class="line"><span style="color:#A6ACCD;">uefi_stub</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/usr/lib/gummiboot/linuxx64.efi.stub</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>the <code>uefi=yes</code> is the main option that produces the *.efi binary, and <code>uefi_stub</code> is required do that.</p><p>Now, since grub is going to get out of the way, we also need to specify the kernel parameters here so that they are passed at the boot time.</p><p>Currently used kernel parameters can be fetched from the <code>/proc/cmdline</code> file. So let&#39;s extract them, with our bash skills:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/proc/cmdline</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sed</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s/^\\| /\\n    /g</span><span style="color:#89DDFF;">&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Now copy them and place it within <code>CMDLINE=</code>, and hence our new config should look like:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">uefi</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span>
<span class="line"><span style="color:#A6ACCD;">uefi_stub</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/usr/lib/gummiboot/linuxx64.efi.stub</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">CMDLINE</span><span style="color:#89DDFF;">=(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">BOOT_IMAGE=/boot/vmlinuz-5.18.19_1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">root=UUID=bb4d72db-5f94-4390-b02c-a4de5a73235f</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">ro</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">loglevel=</span><span style="color:#F78C6C;">4</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">acpi_osi=Windows 2020</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">net.ifnames=</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">i915.enable_psr=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">intel_pstate=disable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">nvme.noacpi=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">intel_iommu=on</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">rd.driver.pre=vfio-pci</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">kvm.ignore_msrs=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">kernel_cmdline</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;\${</span><span style="color:#A6ACCD;">CMDLINE</span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">*</span><span style="color:#89DDFF;">]}&quot;</span></span>
<span class="line"><span style="color:#82AAFF;">unset</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CMDLINE</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>After that we&#39;re ready to create and add that *.efi into our boot entry:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">dracut</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--force</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--verbose</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--kver</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">uname</span><span style="color:#C3E88D;"> -r</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">my-dracut-uki.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux+initramfs.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/boot/efi/EFI/void_custom/</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux+initramfs.efi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/boot/efi/EFI/void_custom/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">efibootmgr</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--create</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--disk</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/dev/nvme0n1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--label</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Void Linux - Custom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--loader</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/EFI/void_custom/linux+initramfs.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">efibootmgr</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># lists boot order</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># manually set boot order making this UKI (0002) in higher priority</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">efibootmgr</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--bootorder</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0002</span><span style="color:#C3E88D;">,0001,2001,2002,2003</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Time to reboot and ensure everything works just like before, grub should be skipped and boot should happen from our new UKI <code>linux+initramfs.efi</code> image, and that will be significantly faster to boot than booting normally.</p><h2 id="instead-of-conclusion" tabindex="-1">Instead of conclusion <a class="header-anchor" href="#instead-of-conclusion" aria-label="Permalink to &quot;Instead of conclusion&quot;">​</a></h2><p>Hopefully the article have given a good insight on how computers start, UEFI firmware-descriptor (fd), *.efi image (or binaries), and how later they use everything else to make computer run fully functioning. As well as for you to set-up a test environment for running that.</p><p>UKIs are also a great way to reduce the boot-time of the system.</p><p>Working with UEFI has great potentials, there&#39;s projects like <a href="https://github.com/hartwork/grub2-theme-preview" target="_blank" rel="noreferrer">grub2-theme-preview</a> that helps you try out <a href="https://github.com/Jacksaur/Gorgeous-GRUB" target="_blank" rel="noreferrer">some great grub2-themes</a>, and you can also get started with embedded development, <a href="https://github.com/tianocore/edk2" target="_blank" rel="noreferrer">EDK2</a> is a community project for UEFI development, that is also used by <a href="https://github.com/ventoy/Ventoy" target="_blank" rel="noreferrer">Ventoy</a> a tool to create multi-boot USB with ease.</p><p>You can also make a custom portable pre-configured linux images, in a USB-drive that is loaded on the RAM using <code>root=live:&lt;URL&gt;</code> kernel parameter <a href="https://man7.org/linux/man-pages/man7/dracut.cmdline.7.html" target="_blank" rel="noreferrer">more info on dracut man page</a>, that you can plug anywhere, and it&#39;ll contain all the configurations you like immediately after boot.</p><p>Backlinks:</p><ul><li><a href="https://www.reddit.com/r/embedded/comments/13dmyqo/demystifying_uefi_article" target="_blank" rel="noreferrer">r/embedded</a> | <a href="https://www.reddit.com/r/linux/comments/13dn6he/demystifying_uefi_building_unified_kernel_images" target="_blank" rel="noreferrer">r/linux</a> | <a href="https://www.reddit.com/r/voidlinux/comments/13dn3k8/demystifying_uefi_article" target="_blank" rel="noreferrer">r/voidlinux</a></li><li><a href="https://www.linkedin.com/posts/animeshz_demystifying-uefi-activity-7062002173936644096-2qv6" target="_blank" rel="noreferrer">LinkedIn</a></li></ul>`,65);function _(s,v,k,B,I,x){const y=a("BlogMetadata"),u=a("ClientOnly"),p=a("Quote");return c(),D("div",null,[o("h1",h,[n(d(s.$frontmatter.title)+" ",1),f]),e(u,null,{default:l(()=>{var t,r;return[(((t=s.$frontmatter)==null?void 0:t.aside)??!0)&&(((r=s.$frontmatter)==null?void 0:r.showArticleMetadata)??!0)?(c(),F(y,{key:0,frontmatter:s.$frontmatter,wordCount:1980},null,8,["frontmatter"])):m("",!0)]}),_:1}),g,e(p,{author:"Linus Torvalds"},{default:l(()=>[n("Theory and practice sometimes clash. And when that happens, theory loses."),E,n("Every single time.")]),_:1}),w,e(p,{author:"Steve Jobs"},{default:l(()=>[n("Stay hungry, stay foolish.")]),_:1})])}const U=C(A,[["render",_]]);export{S as __pageData,U as default};
