<!DOCTYPE html>
<html lang="en-IN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Demystifying UEFI | Animesh Sahu</title>
    <meta name="description" content="Easily understand everything you're missing about UEFI">
    <meta name="generator" content="VitePress v1.3.4">
    <link rel="preload stylesheet" href="/site/assets/style.Dj7ZZD0q.css" as="style">
    
    <script type="module" src="/site/assets/app.CUtul3wv.js"></script>
    <link rel="modulepreload" href="/site/assets/chunks/framework.BIeOwSkr.js">
    <link rel="modulepreload" href="/site/assets/chunks/VPLocalSearchBox.DEAP03r4.js">
    <link rel="modulepreload" href="/site/assets/blogs_demystifying-uefi.md.uJAx21Yv.lean.js">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Klee+One:wght@600&amp;display=swap%22">
    <link rel="alternate" type="application/rss+xml" href="/site/rss.xml" title="Animesh Sahu | Sitewide RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="/site/atom.xml" title="Animesh Sahu | Sitewide Atom Feed">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-a0af88ad><!--[--><!--]--><!--[--><span tabindex="-1" data-v-07f27c84></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-07f27c84> Skip to content </a><!--]--><!----><header class="VPNav" data-v-a0af88ad data-v-94b019dd><div class="VPNavBar" data-v-94b019dd data-v-6a61ff58><div class="wrapper" data-v-6a61ff58><div class="container" data-v-6a61ff58><div class="title" data-v-6a61ff58><div class="VPNavBarTitle" data-v-6a61ff58 data-v-f8ccd9b0><a class="title" href="/site/" data-v-f8ccd9b0><!--[--><!--]--><!----><span data-v-f8ccd9b0>Animesh Sahu / Home</span><!--[--><!--]--></a></div></div><div class="content" data-v-6a61ff58><div class="content-body" data-v-6a61ff58><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6a61ff58><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6a61ff58 data-v-d368eb94><span id="main-nav-aria-label" class="visually-hidden" data-v-d368eb94> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/site/" tabindex="0" data-v-d368eb94 data-v-c28d206a><!--[--><span data-v-c28d206a>🏠 Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/site/blogs/" tabindex="0" data-v-d368eb94 data-v-c28d206a><!--[--><span data-v-c28d206a>📝 Blogs</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/site/notes/" tabindex="0" data-v-d368eb94 data-v-c28d206a><!--[--><span data-v-c28d206a>📔 Notes</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/site/projects/" tabindex="0" data-v-d368eb94 data-v-c28d206a><!--[--><span data-v-c28d206a>🚀 Projects</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/site/journal/" tabindex="0" data-v-d368eb94 data-v-c28d206a><!--[--><span data-v-c28d206a>✍🏻 Journal</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6a61ff58 data-v-53f1d564><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-53f1d564 data-v-ead85328 data-v-fb57c1c6><span class="check" data-v-fb57c1c6><span class="icon" data-v-fb57c1c6><!--[--><span class="vpi-sun sun" data-v-ead85328></span><span class="vpi-moon moon" data-v-ead85328></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6a61ff58 data-v-ab886c99 data-v-9fbf789f><!--[--><a class="VPSocialLink no-icon" href="/site/atom.xml" aria-label target="_blank" rel="noopener" data-v-9fbf789f data-v-a6d790d0><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rss" viewBox="0 0 16 16"><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"/></svg></a><a class="VPSocialLink no-icon" href="https://github.com/Animeshz/site" aria-label="github" target="_blank" rel="noopener" data-v-9fbf789f data-v-a6d790d0><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6a61ff58 data-v-62d0ba9e data-v-b804da08><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b804da08><span class="vpi-more-horizontal icon" data-v-b804da08></span></button><div class="menu" data-v-b804da08><div class="VPMenu" data-v-b804da08 data-v-82d34753><!----><!--[--><!--[--><!----><div class="group" data-v-62d0ba9e><div class="item appearance" data-v-62d0ba9e><p class="label" data-v-62d0ba9e>Appearance</p><div class="appearance-action" data-v-62d0ba9e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-62d0ba9e data-v-ead85328 data-v-fb57c1c6><span class="check" data-v-fb57c1c6><span class="icon" data-v-fb57c1c6><!--[--><span class="vpi-sun sun" data-v-ead85328></span><span class="vpi-moon moon" data-v-ead85328></span><!--]--></span></span></button></div></div></div><div class="group" data-v-62d0ba9e><div class="item social-links" data-v-62d0ba9e><div class="VPSocialLinks social-links-list" data-v-62d0ba9e data-v-9fbf789f><!--[--><a class="VPSocialLink no-icon" href="/site/atom.xml" aria-label target="_blank" rel="noopener" data-v-9fbf789f data-v-a6d790d0><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rss" viewBox="0 0 16 16"><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"/></svg></a><a class="VPSocialLink no-icon" href="https://github.com/Animeshz/site" aria-label="github" target="_blank" rel="noopener" data-v-9fbf789f data-v-a6d790d0><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6a61ff58 data-v-fbc22365><span class="container" data-v-fbc22365><span class="top" data-v-fbc22365></span><span class="middle" data-v-fbc22365></span><span class="bottom" data-v-fbc22365></span></span></button></div></div></div></div><div class="divider" data-v-6a61ff58><div class="divider-line" data-v-6a61ff58></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-a0af88ad data-v-07a84835><div class="container" data-v-07a84835><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-07a84835 data-v-22d6e4e8><button data-v-22d6e4e8>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-a0af88ad data-v-3c531c71><div class="VPDoc has-aside" data-v-3c531c71 data-v-d037b72c><!--[--><!--]--><div class="container" data-v-d037b72c><div class="aside" data-v-d037b72c><div class="aside-curtain" data-v-d037b72c></div><div class="aside-container" data-v-d037b72c><div class="aside-content" data-v-d037b72c><div class="VPDocAside" data-v-d037b72c data-v-53740390><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-53740390 data-v-7c6fcd35><div class="content" data-v-7c6fcd35><div class="outline-marker" data-v-7c6fcd35></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-7c6fcd35>Table of Contents</div><ul class="VPDocOutlineItem root" data-v-7c6fcd35 data-v-5a646e56><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-53740390></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-d037b72c><div class="content-container" data-v-d037b72c><!--[--><!--]--><main class="main" data-v-d037b72c><div style="position:relative;" class="vp-doc _site_blogs_demystifying-uefi" data-v-d037b72c><div><h1 id="frontmatter-title" tabindex="-1">Demystifying UEFI <a class="header-anchor" href="#frontmatter-title" aria-label="Permalink to &quot;{{ $frontmatter.title }}&quot;">​</a></h1><!----><p><img src="/site/assets/processor-chip.BKE3h4rp.jpg" alt="Cover Image"></p><p><strong>Today</strong> I did something really cool, made UKI (in the article) after few weeks of attempt.</p><p>Has this ever happened to you? After a long time, errors seem to go away and <em>everything starts working again</em>. Its such a nice feeling.</p><p>As an occassional low-level programming enjoyer, it feels really nice to work with something that you use everyday but are unaware of how it really works under the hood.</p><p>Let me show it by example, <em>sqaure root</em>, a simple thing right? How does it look in code, more simply how do you calculate it except just hit n trial? Computer does it in a deterministic way. Although I needed atleast 25-30 jump-to-definitions in Java&#39;s source code to find out how it actually worked. And simplified, its as simple as:</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#C792EA;">double</span><span style="color:#82AAFF;"> sqrt</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">double</span><span style="color:#BABED8;font-style:italic;"> n</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  double</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> n</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">  // TBH anything, really, except 0 ofc.</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#89DDFF;"> (</span><span style="color:#C792EA;">int</span><span style="color:#BABED8;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;"> 100</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    a </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 0.5</span><span style="color:#89DDFF;"> *</span><span style="color:#89DDFF;"> (</span><span style="color:#F07178;">a </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> n</span><span style="color:#89DDFF;">/</span><span style="color:#F07178;">a</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>What the ƒυ¢к? Weren&#39;t we trying to calculate n to the power of 1/2? Really we do, but we can write the equation of power 1/2 in linear form (power 1). Now for those interested in how does this work, refer <a href="https://en.wikipedia.org/wiki/Newton%27s_method#Description" target="_blank" rel="noreferrer">Newton&#39;s Method</a>, its really simple.</p><p>The point is, exploring 25-30 definition jumps was worth it in the end!</p><p><em>UEFI</em> is quite similar too, its something that we use every single day, yet we&#39;re mostly unaware of how it works, and hence the curious boy will do everything to unravel the mystery.</p><h2 id="fundamentals-about-computers" tabindex="-1">Fundamentals about computers <a class="header-anchor" href="#fundamentals-about-computers" aria-label="Permalink to &quot;Fundamentals about computers&quot;">​</a></h2><p>I recently saw a video <a href="https://youtu.be/ZSSNFkEMv24" target="_blank" rel="noreferrer">What is voltage? (joke video)</a> posted on the April fools day, questioning why did it take you 5 years to fully understand the voltage. Its really funny one, I&#39;d encourage you to check it out. Its really feels daunting when society makes it difficult, by telling partial-statements and incrementally correct it out with time while not telling the most obvious truth.</p><p>It may seem a bit <em>boring</em>, maybe. But the way we want to start demystifying UEFI is by looking at the most obvious truth about computers.</p><p>That computers are made up of little switches (also known as transistors). When we press the power button, we let some electricity flow into the BIOS/CMOS chip for a short duration of time. These chips generally contains an EPROM (Erasable Programmable Read-Only Memory) which is flashed with something called as a firmware-descriptor (fd) through some equipments externally.</p><p>With a small flow of electricity, the firmware-descriptor present (which also contains the UEFI screen you see by pressing f2/f10 at the boot time), in the chip starts the booting sequence, by opening some gate and activating DRAM, then CPU then rest of the components.</p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Efi-simple.svg/1200px-Efi-simple.svg.png" width="40%" style="margin:auto;"><p>Once the RAM and the CPU is functional for the first time, it scans all the vFAT partitions in the connected drives and start looking for <code>/EFI/*/*.efi</code> files. Once it finds one, it tries to launch and give full hardware control to it.</p><h2 id="the-efi-file" tabindex="-1">The *.efi file <a class="header-anchor" href="#the-efi-file" aria-label="Permalink to &quot;The \*.efi file&quot;">​</a></h2><p>This one&#39;s really <em>interesting</em>. When your computer has just started off, it knows nothing about what to do, and this is the first file that tells it what to do.</p><p>In contrast, the *.efi file is just a simple binary, except that a few restrictions have been imposed by the <a href="https://uefi.org/sites/default/files/resources/UEFI%20Spec%202.8B%20May%202020.pdf" target="_blank" rel="noreferrer">UEFI Specifications</a>, namely the binary must use Microsoft ABI, be position independent, and the binary format should be PE32+ (self-contained) not the regular ELF (OS-dependent) that we use.</p><p>If we understand even a bit of it, we know that we need to build a binary targeting Microsoft Windows, and it doesn&#39;t use any of standard libraries (since there&#39;s no OS).</p><p>So let&#39;s just make a Hello World efi binary, because,</p><div class="quote" data-v-0d7e63f3><!--[-->Theory and practice sometimes clash. And when that happens, theory loses.<br>Every single time.<!--]--><p style="text-align:right;" data-v-0d7e63f3>- Linus Torvalds</p></div><h3 id="efi-programming-model" tabindex="-1">EFI Programming Model <a class="header-anchor" href="#efi-programming-model" aria-label="Permalink to &quot;EFI Programming Model&quot;">​</a></h3><p>Before we begin, we first have to know a few things,</p><ul><li>We can&#39;t use any of the standard headers that depend on the OS, not even <code>iostream</code> or <code>stdio.h</code>.</li><li>UEFI fd exposes a few functionalities by giving our efi entrypoint two parameters, that are pointer of <code>EFI_HANDLE</code> and <code>EFI_SYSTEM_TABLE</code>. The one that is useful to us is the latter one, it&#39;ll let us write to the console.</li><li>LLVM/Clang compiler toolchain (clang+lld) provides built-in support for cross-compilation (otherwise we&#39;d have to <a href="https://github.com/Animeshz/mainstream-cross-compilers" target="_blank" rel="noreferrer">compile gcc targeting windows</a> and even after that we&#39;d have to tell it to use Microsoft ABI at link-time).</li></ul><h3 id="hello-world-in-efi" tabindex="-1">Hello World in EFI <a class="header-anchor" href="#hello-world-in-efi" aria-label="Permalink to &quot;Hello World in EFI&quot;">​</a></h3><p>First let&#39;s install the dependencies we&#39;d require to build our first EFI code:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> xbps-install</span><span style="color:#C3E88D;"> clang</span><span style="color:#C3E88D;"> lld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Here&#39;s a basic <code>Makefile</code> setup for compiling our first EFI code.</p><div class="language-make line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">make</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">CC </span><span style="color:#89DDFF;">:=</span><span style="color:#BABED8;"> clang</span></span>
<span class="line"><span style="color:#BABED8;">LD </span><span style="color:#89DDFF;">:=</span><span style="color:#BABED8;"> lld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">CFLAGS </span><span style="color:#89DDFF;">:=</span><span style="color:#BABED8;"> -ffreestanding -MMD -mno-red-zone -std=c11 -target x86_64-unknown-windows</span></span>
<span class="line"><span style="color:#BABED8;">LDFLAGS </span><span style="color:#89DDFF;">:=</span><span style="color:#BABED8;"> -flavor link -subsystem:efi_application -entry:efi_main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">default</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> all clean</span></span>
<span class="line"><span style="color:#82AAFF;">all</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> main.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">%</span><span style="color:#82AAFF;">.o</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> %</span><span style="color:#BABED8;">.c</span></span>
<span class="line"><span style="color:#89DDFF;">	$(</span><span style="color:#BABED8;">CC</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> $(</span><span style="color:#BABED8;">CFLAGS</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> -c $&lt; -o $@</span></span>
<span class="line"><span style="color:#F07178;">%</span><span style="color:#82AAFF;">.efi</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> %</span><span style="color:#BABED8;">.o</span></span>
<span class="line"><span style="color:#89DDFF;">	$(</span><span style="color:#BABED8;">LD</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> $(</span><span style="color:#BABED8;">LDFLAGS</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> $&lt; -out:$@</span></span>
<span class="line"><span style="color:#82AAFF;">clean</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">	rm -fv *.o *.d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">.PHONY</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> clean all default</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Let&#39;s open up <code>main.c</code> now and define out entry point,</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#C3E88D;">stdint.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">uint64_t</span><span style="color:#82AAFF;"> efi_main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">handle</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> void</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">system_table</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>and run <code>make</code>, it should produce a <code>main.efi</code> file, and we can run <code>file main.efi</code> to ensure its metadata are as expected.</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#C3E88D;"> make</span></span>
<span class="line"><span style="color:#FFCB6B;">clang</span><span style="color:#C3E88D;"> -ffreestanding</span><span style="color:#C3E88D;"> -MMD</span><span style="color:#C3E88D;"> -mno-red-zone</span><span style="color:#C3E88D;"> -std=c11</span><span style="color:#C3E88D;"> -target</span><span style="color:#C3E88D;"> x86_64-unknown-windows</span><span style="color:#C3E88D;"> -c</span><span style="color:#C3E88D;"> main.c</span><span style="color:#C3E88D;"> -o</span><span style="color:#C3E88D;"> main.o</span></span>
<span class="line"><span style="color:#FFCB6B;">lld</span><span style="color:#C3E88D;"> -flavor</span><span style="color:#C3E88D;"> link</span><span style="color:#C3E88D;"> -subsystem:efi_application</span><span style="color:#C3E88D;"> -entry:efi_main</span><span style="color:#C3E88D;"> main.o</span><span style="color:#C3E88D;"> -out:main.efi</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#C3E88D;"> -fv</span><span style="color:#BABED8;"> *</span><span style="color:#C3E88D;">.o</span><span style="color:#BABED8;"> *</span><span style="color:#C3E88D;">.d</span></span>
<span class="line"><span style="color:#FFCB6B;">removed</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">main.o</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">removed</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">main.d</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#C3E88D;"> file</span><span style="color:#C3E88D;"> main.efi</span></span>
<span class="line"><span style="color:#FFCB6B;">main.efi:</span><span style="color:#C3E88D;"> PE32+</span><span style="color:#C3E88D;"> executable</span><span style="color:#BABED8;"> (EFI </span><span style="color:#C3E88D;">application</span><span style="color:#BABED8;">) x86-64, </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#BABED8;"> MS Windows</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="making-a-test-environment" tabindex="-1">Making a test environment <a class="header-anchor" href="#making-a-test-environment" aria-label="Permalink to &quot;Making a test environment&quot;">​</a></h3><p>Till now, everything seems great, although I don&#39;t think its a good idea to just throw the efi file to the <code>/boot/efi</code> and start booting your laptop/pc from it.</p><p>A better approach would be to spin up a small qemu vm and run the efi image/binary from there.</p><p>First let&#39;s install the dependencies:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> xbps-install</span><span style="color:#C3E88D;"> qemu</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Now we spin up a new qemu vm with current directory serving as a root filesystem to the vm:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">qemu-system-x86_64</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -drive</span><span style="color:#C3E88D;"> if=pflash,format=raw,readonly,file=/usr/share/qemu/edk2-x86_64-code.fd</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -drive</span><span style="color:#C3E88D;"> format=raw,file=fat:rw:</span><span style="color:#BABED8;">$PWD \</span></span>
<span class="line"><span style="color:#C3E88D;">     -net</span><span style="color:#C3E88D;"> none</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -nographic</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The important options are the two <code>-drive</code> options, first tells the VM to use the edk2 firmware-descriptor as UEFI (similar to one flashed on to your EPROM in the BIOS chip), the second mounts current directory (<code>$PWD</code>) as a vFAT filesystem in the VM.</p><p>Rest of options are just personal preference, <code>-net none</code> tells to not provide any network access to the vm, <code>-nographic</code> tells qemu can occupy our current terminal instead of a new graphical window (its convenient as I&#39;m majorly a keyboard-centric guy).</p><p>This should drop you to a EFI shell, to load your efi file, run the following:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">Shell</span><span style="color:#BABED8;">&gt; </span><span style="color:#C3E88D;">fs0:</span></span>
<span class="line"><span style="color:#FFCB6B;">fs0:\</span><span style="color:#BABED8;">&gt; </span><span style="color:#C3E88D;">main.efi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>It outputs nothing, and that&#39;s good thing because there were no errors, hence everything worked perfectly!</p><h3 id="hello-world-in-efi-continue" tabindex="-1">Hello World in EFI (continue) <a class="header-anchor" href="#hello-world-in-efi-continue" aria-label="Permalink to &quot;Hello World in EFI (continue)&quot;">​</a></h3><p>So far, we ran the efi binary, but we didn&#39;t print &quot;Hello World&quot; as we promised. So let&#39;s just do exactly that.</p><p>To do that, we can&#39;t use <code>iostream</code> or <code>stdio.h</code>, since there&#39;s no OS outside the UEFI environment there&#39;s no implementation of those headers, but we know that UEFI gave us two paramters in our entry point. Maybe that could help us?</p><p>And the answer is yes, the UEFI has started the screen and knows how to write something to the console, the pointer to <code>EFI_SYSTEM_TABLE</code> contains routines (function pointers) that we can call to perform some actions available.</p><p>So, let&#39;s modify our <code>main.c</code> file:</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#C3E88D;">stdint.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#C3E88D;">stdbool.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#C792EA;"> struct</span><span style="color:#FFCB6B;"> efi_table_header</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#F07178;"> signature</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint32_t</span><span style="color:#F07178;"> revision</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint32_t</span><span style="color:#F07178;"> header_size</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint32_t</span><span style="color:#F07178;"> crc32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint32_t</span><span style="color:#F07178;"> reserved</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#FFCB6B;"> efi_table_header</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#C792EA;"> struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused1</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> bool</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">output_string</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint16_t</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">string</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused2</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint16_t</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused3</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused4</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused5</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">clear_screen</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">self</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused6</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> uint64_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#89DDFF;"> (*</span><span style="color:#BABED8;">unused7</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">struct</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#C792EA;"> *</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> bool</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#FFCB6B;"> efi_simple_text_output_protocol</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#C792EA;"> struct</span><span style="color:#FFCB6B;"> efi_system_table</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  efi_table_header header</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint16_t</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint32_t</span><span style="color:#F07178;"> unused2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused3</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused5</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  efi_simple_text_output_protocol </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">out</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused6</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused7</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused9</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  uint64_t</span><span style="color:#F07178;"> unused10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  void</span><span style="color:#89DDFF;"> *</span><span style="color:#F07178;">unused11</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#FFCB6B;"> efi_system_table</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">uint64_t</span><span style="color:#82AAFF;"> efi_main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">handle</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> efi_system_table</span><span style="color:#C792EA;"> *</span><span style="color:#BABED8;font-style:italic;">system_table</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">   uint16_t</span><span style="color:#BABED8;"> msg[] </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> u&quot;</span><span style="color:#C3E88D;">Hello World!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">   uint64_t</span><span style="color:#BABED8;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">   status </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;">out</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">clear_screen</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;">out</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">   if</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">     return</span><span style="color:#BABED8;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">   status </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;">out</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">output_string</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">system_table</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;">out</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">   if</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">     return</span><span style="color:#BABED8;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">   while</span><span style="color:#89DDFF;"> (</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">   return</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>Ok, too much to ingest. But first let&#39;s compile and run,</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#C3E88D;"> make</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#C3E88D;"> qemu-system-x86_64</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -drive</span><span style="color:#C3E88D;"> if=pflash,format=raw,readonly,file=/usr/share/qemu/edk2-x86_64-code.fd</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -drive</span><span style="color:#C3E88D;"> format=raw,file=fat:rw:</span><span style="color:#BABED8;">$PWD \</span></span>
<span class="line"><span style="color:#C3E88D;">     -net</span><span style="color:#C3E88D;"> none</span><span style="color:#BABED8;"> \</span></span>
<span class="line"><span style="color:#C3E88D;">     -nographic</span></span>
<span class="line"><span style="color:#FFCB6B;">Shell</span><span style="color:#BABED8;">&gt; </span><span style="color:#C3E88D;">fs0:</span></span>
<span class="line"><span style="color:#FFCB6B;">fs0:\</span><span style="color:#BABED8;">&gt; </span><span style="color:#C3E88D;">main.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">Hello</span><span style="color:#C3E88D;"> World!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Voila! We finally been able to write a Hello World on the UEFI console!</p><p>The code basically defines (because I wanted the code to be any dependency-free), and use the simple text io interface from the <code>EFI_SYSTEM_TABLE</code> (that is the second parameter to our entrypoint).</p><p>Where there are two important function pointers, <code>clear_screen</code> and <code>output_string</code>. It seems that accross the UEFI Specification they mostly use UCS-2 encoded strings (16-bit wide), so we define our string as unicode <code>u&quot;Hello World!&quot;</code> and pass it to the <code>output_string</code>.</p><p>That&#39;s it, now you can start whatever you want to do with UEFI, it also provides graphics and filesystem API through the same <code>EFI_SYSTEM_TABLE</code> so you can draw something or load up other binaries, kernels, and more. And that&#39;s what most UEFI implementations do, like for example <strong>grub</strong>, or other <strong>edk2 applications such as Ventoy</strong>.</p><h2 id="unified-kernel-image-uki" tabindex="-1">Unified Kernel Image (UKI) <a class="header-anchor" href="#unified-kernel-image-uki" aria-label="Permalink to &quot;Unified Kernel Image (UKI)&quot;">​</a></h2><p>Another interesting usecase of learning about UEFI is that now you can make a portable linux efi image. That basically package efi-stub, initramfs/initrd, kernel, (optionally) rootfs all in a single *.efi file. Making computer need no more than a single file to boot up a linux.</p><p>They help us in two ways,</p><ul><li>Allow a direct netboot (without a disk).</li><li>Boot up really <em>really</em> fast (ignoring middle-man like grub).</li></ul><p>Let me tell you a story, a few weeks ago, in our college, we had to create a cluster for ML purposes, where we had to boot multiple computers at once and spin up all of them to do the required things. To do this, we obviously had to create a self-configuring or self-configured image, and perform a netboot (that can be done by serving the file from any computer using simple built-in http server: <code>python3 -m http.server</code>) so that we won&#39;t have to plug the USB stick everytime to each and every of the computers out there, and also to not affect the internal disks (that&#39;s why we&#39;re doing netboot), we had to load everything in RAM. What could be better than Unified Kernel Images?</p><p>And for geeks like us as well, who don&#39;t use more than 1 OS, we don&#39;t really need the grub, and thus we can speed up our boot process by utilizing the UKI.</p><p>So, let&#39;s try building one!</p><h3 id="building-a-uki-for-currently-running-desktop-linux" tabindex="-1">Building a UKI for currently running desktop linux <a class="header-anchor" href="#building-a-uki-for-currently-running-desktop-linux" aria-label="Permalink to &quot;Building a UKI for currently running desktop linux&quot;">​</a></h3><p>Fortunately enough, the dracut generally described as &quot;a low-level tool for generating an initramfs/initrd image&quot;, supports building a UKI. So if you&#39;re on any modern linux distribution and already using dracut under the hood, you can easily adapt to UKI without much of a hassle.</p><p>To do this, first we would need a efi-stub,</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> xbps-install</span><span style="color:#C3E88D;"> gummiboot</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>and then we specify UKI configuration, in a file say <code>my-dracut-uki.conf</code>:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">uefi</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span>
<span class="line"><span style="color:#BABED8;">uefi_stub</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/usr/lib/gummiboot/linuxx64.efi.stub</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>the <code>uefi=yes</code> is the main option that produces the *.efi binary, and <code>uefi_stub</code> is required do that.</p><p>Now, since grub is going to get out of the way, we also need to specify the kernel parameters here so that they are passed at the boot time.</p><p>Currently used kernel parameters can be fetched from the <code>/proc/cmdline</code> file. So let&#39;s extract them, with our bash skills:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#C3E88D;"> /proc/cmdline</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> sed</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">s/^\| /\n    /g</span><span style="color:#89DDFF;">&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Now copy them and place it within <code>CMDLINE=</code>, and hence our new config should look like:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">uefi</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span>
<span class="line"><span style="color:#BABED8;">uefi_stub</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/usr/lib/gummiboot/linuxx64.efi.stub</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">CMDLINE</span><span style="color:#89DDFF;">=(</span></span>
<span class="line"><span style="color:#C792EA;">    BOOT_IMAGE</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/boot/vmlinuz-5.18.19_1</span></span>
<span class="line"><span style="color:#C792EA;">    root</span><span style="color:#89DDFF;">=</span><span style="color:#C792EA;">UUID</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">bb4d72db-5f94-4390-b02c-a4de5a73235f</span></span>
<span class="line"><span style="color:#C3E88D;">    ro</span></span>
<span class="line"><span style="color:#C792EA;">    loglevel</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">4</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#C3E88D;">acpi_osi=Windows 2020</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">    net.</span><span style="color:#C792EA;">ifnames</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#C3E88D;">    i915.</span><span style="color:#C792EA;">enable_psr</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#C792EA;">    intel_pstate</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">disable</span></span>
<span class="line"><span style="color:#C3E88D;">    nvme.</span><span style="color:#C792EA;">noacpi</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#C792EA;">    intel_iommu</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">on</span></span>
<span class="line"><span style="color:#C3E88D;">    rd.driver.</span><span style="color:#C792EA;">pre</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">vfio-pci</span></span>
<span class="line"><span style="color:#C3E88D;">    kvm.</span><span style="color:#C792EA;">ignore_msrs</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">kernel_cmdline</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;${</span><span style="color:#BABED8;">CMDLINE</span><span style="color:#89DDFF;">[*]}&quot;</span></span>
<span class="line"><span style="color:#82AAFF;">unset</span><span style="color:#C3E88D;"> CMDLINE</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>After that we&#39;re ready to create and add that *.efi into our boot entry:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">dracut</span><span style="color:#C3E88D;"> --force</span><span style="color:#C3E88D;"> --verbose</span><span style="color:#C3E88D;"> --kver</span><span style="color:#89DDFF;"> $(</span><span style="color:#FFCB6B;">uname</span><span style="color:#C3E88D;"> -r</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;"> --conf</span><span style="color:#C3E88D;"> my-dracut-uki.conf</span><span style="color:#C3E88D;"> linux+initramfs.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /boot/efi/EFI/void_custom/</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> cp</span><span style="color:#C3E88D;"> linux+initramfs.efi</span><span style="color:#C3E88D;"> /boot/efi/EFI/void_custom/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> efibootmgr</span><span style="color:#C3E88D;"> --create</span><span style="color:#C3E88D;"> --disk</span><span style="color:#C3E88D;"> /dev/nvme0n1</span><span style="color:#C3E88D;"> --label</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">Void Linux - Custom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> --loader</span><span style="color:#C3E88D;"> /EFI/void_custom/linux+initramfs.efi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">efibootmgr</span><span style="color:#676E95;font-style:italic;">  # lists boot order</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># manually set boot order making this UKI (0002) in higher priority</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> efibootmgr</span><span style="color:#C3E88D;"> --bootorder</span><span style="color:#C3E88D;"> 0002,0001,2001,2002,2003</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Time to reboot and ensure everything works just like before, grub should be skipped and boot should happen from our new UKI <code>linux+initramfs.efi</code> image, and that will be significantly faster to boot than booting normally.</p><h2 id="instead-of-conclusion" tabindex="-1">Instead of conclusion <a class="header-anchor" href="#instead-of-conclusion" aria-label="Permalink to &quot;Instead of conclusion&quot;">​</a></h2><p>Hopefully the article have given a good insight on how computers start, UEFI firmware-descriptor (fd), *.efi image (or binaries), and how later they use everything else to make computer run fully functioning. As well as for you to set-up a test environment for running that.</p><p>UKIs are also a great way to reduce the boot-time of the system.</p><p>Working with UEFI has great potentials, there&#39;s projects like <a href="https://github.com/hartwork/grub2-theme-preview" target="_blank" rel="noreferrer">grub2-theme-preview</a> that helps you try out <a href="https://github.com/Jacksaur/Gorgeous-GRUB" target="_blank" rel="noreferrer">some great grub2-themes</a>, and you can also get started with embedded development, <a href="https://github.com/tianocore/edk2" target="_blank" rel="noreferrer">EDK2</a> is a community project for UEFI development, that is also used by <a href="https://github.com/ventoy/Ventoy" target="_blank" rel="noreferrer">Ventoy</a> a tool to create multi-boot USB with ease.</p><p>You can also make a custom portable pre-configured linux images, in a USB-drive that is loaded on the RAM using <code>root=live:&lt;URL&gt;</code> kernel parameter <a href="https://man7.org/linux/man-pages/man7/dracut.cmdline.7.html" target="_blank" rel="noreferrer">more info on dracut man page</a>, that you can plug anywhere, and it&#39;ll contain all the configurations you like immediately after boot.</p><p>Backlinks:</p><ul><li><a href="https://www.reddit.com/r/embedded/comments/13dmyqo/demystifying_uefi_article" target="_blank" rel="noreferrer">r/embedded</a> | <a href="https://www.reddit.com/r/linux/comments/13dn6he/demystifying_uefi_building_unified_kernel_images" target="_blank" rel="noreferrer">r/linux</a> | <a href="https://www.reddit.com/r/voidlinux/comments/13dn3k8/demystifying_uefi_article" target="_blank" rel="noreferrer">r/voidlinux</a></li><li><a href="https://www.linkedin.com/posts/animeshz_demystifying-uefi-activity-7062002173936644096-2qv6" target="_blank" rel="noreferrer">LinkedIn</a></li></ul><div class="quote" data-v-0d7e63f3><!--[-->Stay hungry, stay foolish.<!--]--><p style="text-align:right;" data-v-0d7e63f3>- Steve Jobs</p></div></div></div></main><footer class="VPDocFooter" data-v-d037b72c data-v-eba3502e><!--[--><!--]--><div class="edit-info" data-v-eba3502e><div class="edit-link" data-v-eba3502e><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/Animeshz/site/edit/main/content/blogs/demystifying-uefi.md" target="_blank" rel="noreferrer" data-v-eba3502e><!--[--><span class="vpi-square-pen edit-link-icon" data-v-eba3502e></span> Edit this page<!--]--></a></div><div class="last-updated" data-v-eba3502e><p class="VPLastUpdated" data-v-eba3502e data-v-5eaa2aa0>Last updated: <time datetime="2024-10-11T09:18:19.000Z" data-v-5eaa2aa0></time></p></div></div><!----></footer><!--[--><!--[--><!--[--><div class="prev-next" data-v-51d10272><div class="pager" data-v-51d10272><a class="pager-link prev" href="/site/blogs/void-linux.html" data-v-51d10272><span class="desc" data-v-51d10272>Previous page</span><span class="title" data-v-51d10272>Unmasking the hidden gems of Void Linux</span></a></div><div class="has-prev pager" data-v-51d10272><a class="pager-link next" href="/site/blogs/git.html" data-v-51d10272><span class="desc" data-v-51d10272>Next page</span><span class="title" data-v-51d10272>Learn Git - The easy way</span></a></div></div><div id="gitalk-container"></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blogs_a-critical-analysis-of-linux-landscape.md\":\"Btb9uXlE\",\"blogs_binfmt.md\":\"W2_z6B_l\",\"blogs_chasing-productivity-1.md\":\"DYu3aZLQ\",\"blogs_creating-yet-another-distribution-zxcv-linux-1.md\":\"OmLe-4LT\",\"blogs_demystifying-uefi.md\":\"uJAx21Yv\",\"blogs_git.md\":\"CCUvhr9_\",\"blogs_index.md\":\"BCoJqunX\",\"blogs_linux-1.md\":\"DgbVinqO\",\"blogs_linux-2.md\":\"Bk78mzQD\",\"blogs_ml-tldr.md\":\"DX4XR3nJ\",\"blogs_mono-repos-archiving-github-projects.md\":\"C5MfYqC0\",\"blogs_using-git-for-effective-collaboration.md\":\"r-BGsfPh\",\"blogs_void-linux.md\":\"Dmrxhako\",\"blogs_working-with-binaries.md\":\"Dc5kmbBG\",\"index.md\":\"8ZRJzsa1\",\"journal_2023_july.md\":\"pUntnifw\",\"journal_2023_june.md\":\"0DBP-hFc\",\"journal_index.md\":\"Bg0JsVUi\",\"notes_20-29--devenvironment_21--linux_21.01-zfs.md\":\"BXoom9bO\",\"notes_20-29--devenvironment_21--linux_21.02-nix.md\":\"D_-M_YoH\",\"notes_20-29--devenvironment_21--linux_21.03-cli-utilities.md\":\"BQbH3-bR\",\"notes_20-29--devenvironment_22--text-editors_22.01-emacs.md\":\"Cx8cc-hg\",\"notes_90-99--miscellaneous_91--curation_91.01-note-taking.md\":\"DbV28mBF\",\"notes_90-99--miscellaneous_91--curation_91.02-awesome-resources.md\":\"CGpSjHNx\",\"notes_90-99--miscellaneous_91--curation_91.03-awesome-projects.md\":\"DrLVDAUa\",\"notes_90-99--miscellaneous_92--learnings_92.01-counter-intuitive.md\":\"CQUdfud-\",\"notes_90-99--miscellaneous_92--learnings_92.02-out-of-box.md\":\"DNJC53pM\",\"notes_90-99--miscellaneous_92--learnings_92.03-health.md\":\"DH-yHkLM\",\"notes_index.md\":\"CRWSxAZR\",\"projects_index.md\":\"CyPGSBsr\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-IN\",\"dir\":\"ltr\",\"title\":\"Animesh Sahu\",\"description\":\"I write about wide-variety of untouched topics in a simplified way.\",\"base\":\"/site/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"siteTitle\":\"Animesh Sahu / Home\",\"search\":{\"provider\":\"local\"},\"outline\":[2,6],\"outlineTitle\":\"Table of Contents\",\"socialLinks\":[{\"icon\":{\"svg\":\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" fill=\\\"currentColor\\\" class=\\\"bi bi-rss\\\" viewBox=\\\"0 0 16 16\\\"><path d=\\\"M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z\\\"/></svg>\"},\"link\":\"/site/atom.xml\"},{\"icon\":\"github\",\"link\":\"https://github.com/Animeshz/site\"}],\"editLink\":{\"pattern\":\"https://github.com/Animeshz/site/edit/main/content/:path\"},\"nav\":[{\"text\":\"🏠 Home\",\"link\":\"/\"},{\"text\":\"📝 Blogs\",\"link\":\"/blogs/\"},{\"text\":\"📔 Notes\",\"link\":\"/notes/\"},{\"text\":\"🚀 Projects\",\"link\":\"/projects/\"},{\"text\":\"✍🏻 Journal\",\"link\":\"/journal/\"}],\"sidebar\":{\"/notes/\":[{\"text\":\"20-29--DevEnvironment\",\"items\":[{\"text\":\"<span style=\\\"font-weight: 700;\\\">21--Linux</span>\",\"items\":[{\"text\":\"21.01-ZFS\",\"link\":\"/notes/20-29--DevEnvironment/21--Linux/21.01-ZFS\"},{\"text\":\"21.02-Nix\",\"link\":\"/notes/20-29--DevEnvironment/21--Linux/21.02-Nix\"},{\"text\":\"21.03-Cli-Utilities\",\"link\":\"/notes/20-29--DevEnvironment/21--Linux/21.03-Cli-Utilities\"}]},{\"text\":\"<span style=\\\"font-weight: 700;\\\">22--Text-Editors</span>\",\"items\":[{\"text\":\"22.01-Emacs\",\"link\":\"/notes/20-29--DevEnvironment/22--Text-Editors/22.01-Emacs\"}]}]},{\"text\":\"90-99--Miscellaneous\",\"items\":[{\"text\":\"<span style=\\\"font-weight: 700;\\\">91--Curation</span>\",\"items\":[{\"text\":\"91.01-Note-Taking\",\"link\":\"/notes/90-99--Miscellaneous/91--Curation/91.01-Note-Taking\"},{\"text\":\"91.02-Awesome-Resources\",\"link\":\"/notes/90-99--Miscellaneous/91--Curation/91.02-Awesome-Resources\"},{\"text\":\"91.03-Awesome-Projects\",\"link\":\"/notes/90-99--Miscellaneous/91--Curation/91.03-Awesome-Projects\"}]},{\"text\":\"<span style=\\\"font-weight: 700;\\\">92--Learnings</span>\",\"items\":[{\"text\":\"92.01-Counter-Intuitive\",\"link\":\"/notes/90-99--Miscellaneous/92--Learnings/92.01-Counter-Intuitive\"},{\"text\":\"92.02-Out-Of-Box\",\"link\":\"/notes/90-99--Miscellaneous/92--Learnings/92.02-Out-Of-Box\"},{\"text\":\"92.03-Health\",\"link\":\"/notes/90-99--Miscellaneous/92--Learnings/92.03-Health\"}]}]}]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>